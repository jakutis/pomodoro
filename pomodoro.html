<html>
  <body>
    <div id="app"></div>
    <script>
(function (w) {
  var render = ({actions, handleTextSetter, handleLog}) => {
    var app = w.document.getElementById('app');
    var text = w.document.createElement('p');
    text.style.fontSize = '40vw';
    text.style.textAlign = 'center';
    text.style.margin = '0px';
    app.appendChild(text);
    var toolbar = w.document.createElement('p');
    toolbar.style.textAlign = 'center';
    app.appendChild(toolbar);
    var log = w.document.createElement('ul');
    app.appendChild(log);

    actions.forEach(a => {
      var button = w.document.createElement('button');
      button.appendChild(w.document.createTextNode(a.name));
      button.onclick = () => a.run();
      button.style.fontSize = '10vw';
      button.style.margin = '2vw';
      button.style.padding = '2vw';
      toolbar.appendChild(button);
    });

    handleTextSetter(duration => {
      while (text.firstChild) {
        text.removeChild(text.firstChild);
      }
      var seconds = Math.round(duration / 1000);
      var minutes = Math.floor(seconds / 60);
      seconds = seconds - minutes * 60;
      var string = (minutes < 10 ? '0' : '') + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
      text.appendChild(w.document.createTextNode(string));
    });

    handleLog(items => {
      while (log.firstChild) {
        log.removeChild(log.firstChild);
      }
      items = items.slice().sort((a, b) => b.time - a.time);
      items.forEach(i => {
        var iNode = w.document.createElement('li');
        var time = new Date(i.time).toISOString().replace('T', ' ').replace('Z', '');
        var text = time.substr(0, time.length - 4) + ' ' + i.type;
        iNode.appendChild(w.document.createTextNode(text));
        log.appendChild(iNode);
      });
    });
  };

  var domain = {
    startedAt: 0,
    stoppedAt: 0,
    finishesAt: 0,
    configuration: null,

    initialize: () => {
      domain.configuration = JSON.parse(unescape(w.location.hash.substr(1)) || JSON.stringify({
        duration: 25
      }));
      w.location.hash = JSON.stringify(domain.configuration);
      domain.handle.log(domain.getStore().log);
      domain.initializeTimes();
      domain.tick();
      domain.log('initialize');
    },
    handle: {},
    getStore: () => {
      return JSON.parse(w.localStorage.getItem('jakutis-pomodoro') || '{"log":[]}');
    },
    setStore: (store) => {
      return w.localStorage.setItem('jakutis-pomodoro', JSON.stringify(store));
    },
    log: (type, data) => {
      var store = domain.getStore();
      store.log.push({ type, time: Date.now(), data });
      domain.setStore(store);
      domain.handle.log(store.log);
    },
    tick: () => {
      var currentTime;
      if (domain.stoppedAt > 0) {
        currentTime = domain.stoppedAt;
      } else {
        currentTime = Date.now();
        if (currentTime < domain.finishesAt) {
          requestAnimationFrame(() => domain.tick());
        } else {
          domain.complete();
        }
      }
      domain.handle.text(domain.finishesAt - currentTime);
    },
    start: () => {
      domain.startedAt = Date.now();
      domain.stoppedAt = 0;
      domain.finishesAt = Date.now() + domain.configuration.duration * 60 * 1000;
      domain.tick();
      domain.log('start');
    },
    stop: () => {
      domain.stoppedAt = Date.now();
      domain.tick();
      domain.log('stop');
    },
    complete: () => {
      domain.stoppedAt = Date.now();
      domain.tick();
      domain.log('complete');
    },
    initializeTimes: () => {
      domain.startedAt = 0;
      domain.stoppedAt = Date.now();
      domain.finishesAt = Date.now() + domain.configuration.duration * 60 * 1000;
    },
    reset: () => {
      domain.initializeTimes();
      domain.tick();
      domain.log('reset');
    }
  };

  // TODO UI to show that I acknowledged end
  render({
    handleTextSetter: setText => domain.handle.text = setText,
    handleLog: setLog => domain.handle.log = setLog,
    actions: [
      {
        name: 'start',
        run: () => domain.start()
      },
      {
        name: 'stop',
        run: () => domain.stop()
      },
      {
        name: 'reset',
        run: () => domain.reset()
      }
    ]
  });
  w.onhashchange = () => domain.initialize();
  domain.initialize();
})(window);
    </script>
  </body>
</html>